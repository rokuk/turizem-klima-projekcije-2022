---
title: "Weather stations"
output: github_document
---

This code reads data from Excel files (received from ARSO) and makes plots for 
selected stations.

## Importing libraries and data

```{r}
library(readxl)
library(dplyr)
library(purrr)
library(forcats)
library(ggplot2)
library(sf)
library(rnaturalearth)
```

Define variable values:

```{r}
filenames <- c("rr1", "rr2", "snow", "warm", "hot", "tropical") # excel file names
variablenames <- c("Days with at least 1 mm of precipitation", "Days with at least 20 mm of precipitation", "Days with snow", expression("Warm days (T"["max"]*" \u2265 25\u00B0C)"), expression("Hot days (T"["max"]*" \u2265 30\u00B0C)"), expression("Tropical nights (T"["min"]*" \u2265 20\u00B0C)")) # display variable names
axislabels <- c("number of days per month", "number of days per month", "number of days per month", "number of days per month", "number of days per month", "number of nights per month")
projnames <- c("RCP45", "RCP85", "RCP26") # excel sheet names
scenarionames <- c("RCP4.5", "RCP8.5", "RCP2.6") # display scenario names
monthnames <- c("jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
```

Read data from Excel files:

```{r}
refdata <- data.frame(matrix(nrow=0, ncol=6))
projdata <- data.frame(matrix(nrow=0, ncol=8))

for (file in filenames) {
    # read reference data
    ref <- read_excel(paste("../data/arso/", file, ".xlsx", sep=""), sheet=1)
    colnames <- names(ref)
    ref$month <- fct_relabel(factor(ref$month), function(x) monthnames[as.numeric(x)])
    
    for (statid in 2:length(colnames)) {
        refdata <- rbind(refdata, data.frame(
            var = file,
            period = "1981-2010",
            scenario = "ref",
            month = ref$month,
            station = colnames[statid],
            refvalue = pull(ref, colnames[statid])
        ))
    }
    
    # read RCP4.5, RCP8.5 and RCP2.6 data
    for (projid in 1:3) {
        proj <- read_excel(paste("../data/arso/", file, ".xlsx", sep=""), sheet = projid+1)
        proj$month <- fct_relabel(factor(proj$month), function(x) monthnames[as.numeric(x)])
        projdata <- rbind(projdata, data.frame(
            var = file,
            period = proj$period,
            scenario = scenarionames[projid],
            month = proj$month,
            station = proj$station,
            median = proj$median,
            min = proj$min,
            max = proj$max
        ))
    }
}

head(refdata)
head(projdata)
```

## Data wrangling

Projection data is given as a deviation from the reference value.
Get reference values for each projection datapoint and add them to median, 
min and max values to obtain actual projection values:

```{r}
refvals <- c()
for (i in 1:nrow(projdata)) {
    refvals <- rbind(refvals, refdata[refdata$month==projdata[i,4] & refdata$station==projdata[i,5] & refdata$var==projdata[i,1], "refvalue"])
}

projdata$median <- projdata$median + refvals
projdata$min <- projdata$min + refvals
projdata$max <- projdata$max + refvals

head(projdata)
```

Combine reference and projection data frames for plotting, also rename stations:

```{r}
alldata <- data.frame(matrix(nrow=0, ncol=8))
alldata <- rbind(alldata, projdata)

names(refdata)[names(refdata) == "refvalue"] <- "median"
refdata$min <- NA # reference data error bar range is set to 0
refdata$max <- NA

# add reference data to alldata frame for each scenario
refdata$scenario <- "RCP4.5"
alldata <- rbind(alldata, refdata)
refdata$scenario <- "RCP8.5"
alldata <- rbind(alldata, refdata)
refdata$scenario <- "RCP2.6"
alldata <- rbind(alldata, refdata)

alldata[alldata$station=="BILJE", "station"] <- "Bilje"
alldata[alldata$station=="CELJE - MEDLOG", "station"] <- "Celje Medlog"
alldata[alldata$station=="LETALIŠČE EDVARDA RUSJANA MARIBOR", "station"] <- "Letališče Edvarda Rusjana Maribor"
alldata[alldata$station=="LJUBLJANA - BEŽIGRAD", "station"] <- "Ljubljana Bežigrad"
alldata[alldata$station=="MURSKA SOBOTA - RAKIČAN", "station"] <- "Murska Sobota Rakičan"
alldata[alldata$station=="NOVO MESTO", "station"] <- "Novo mesto"
alldata[alldata$station=="PORTOROŽ - LETALIŠČE", "station"] <- "Portorož letališče"
alldata[alldata$station=="RATEČE", "station"] <- "Rateče"
alldata[alldata$station=="ŠMARTNO PRI SLOVENJ GRADCU", "station"] <- "Šmartno pri Slovenj Gradcu"
```

## Plots

```{r}
plotdata <- function(alldata, variable, stat) {
    subset <- filter(alldata, var==variable & station==stat)

    p <- ggplot(data = subset, 
                mapping = aes(x = period, y = median, fill = period)) + 
        geom_col() +
        facet_grid(scenario~month) + 
        scale_fill_manual(values = c("#009E73", "#E69F00", "#56B4E9", "#D55E00")) +
        scale_y_continuous(expand = expansion(mult = c(0, 0.02))) +
        ylab(axislabels[match(variable, filenames)]) + 
        labs(title = variablenames[match(variable, filenames)], subtitle = stat, fill="period") +
        geom_errorbar(mapping = aes(ymax=max, ymin=min), stat="identity", size=0.3, width=0.9) +
        theme(panel.grid.major.x = element_blank(),
              axis.title.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.text.x=element_blank())
    
    return (p)
}

plotdata2 <- function(alldata, variable, scen) {
    subset <- filter(alldata, var==variable & scenario==scen)

    p <- ggplot(data = subset, 
                mapping = aes(x = period, y = median, fill = period)) + 
        geom_col() +
        facet_grid(station~month, labeller = label_wrap_gen(width=10)) + 
        scale_fill_manual(values = c("#009E73", "#E69F00", "#56B4E9", "#D55E00")) +
        scale_y_continuous(expand = expansion(mult = c(0, 0.02))) +
        ylab(axislabels[match(variable, filenames)]) + 
        labs(title = variablenames[match(variable, filenames)], subtitle = scen, fill="period") +
        geom_errorbar(mapping = aes(ymax=max, ymin=min), stat="identity", size=0.3, width=0.9) +
        theme(panel.grid.major.x = element_blank(),
              axis.title.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.text.x=element_blank(),
              strip.text.y.right = element_text(angle = 0))
    
    return (p)
}

#plotdata(alldata, "rr1", "Rateče")
#plotdata2(alldata, "snow", "RCP4.5")
```

```{r, dpi=300, fig.width=8, fig.height=4}
for (var in filenames) {
    for (stat in distinct(alldata, station)$station) {
        p <- plotdata(alldata, var, stat)
        print(p)
    }
}
```

```{r, dpi=300, fig.width=8, fig.height=8}
for (var in filenames) {
    for (scen in c("RCP2.6", "RCP4.5", "RCP8.5")) {
        p <- plotdata2(alldata, var, scen)
        print(p)
    }
}
```

Save all the plots:

```{r, eval=FALSE}
for (var in filenames) {
    for (stat in distinct(alldata, station)$station) {
        print(paste(var, stat))

        p <- plotdata(alldata, var, stat)
        
        ggsave(paste("stations_", gsub(" ", "_", stat_name), "_", scen, ".pdf", sep=""), p, width=9, height=4, units="in", path="../output", device=cairo_pdf)
        ggsave(paste("stations_", gsub(" ", "_", stat_name), "_", scen, ".eps", sep=""), p, width=9, height=4, units="in", path="../output", device=cairo_ps)
        ggsave(paste("stations_", gsub(" ", "_", stat_name), "_", scen, ".png", sep=""), p, width=9, height=4, units="in", path="../output", dpi=500)
    }
}
```